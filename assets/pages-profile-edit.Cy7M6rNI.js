import{a8 as a,U as e,B as s,q as t,a3 as r,n as l,j as o,a4 as i,ac as u,ad as n,ae as c,O as d,af as m,ag as h,l as p,ah as f,p as v,ai as g,_,D as b,c as w,w as P,i as U,o as x,a as V,b as y,e as A,d as N,I as j,aj as E,a6 as F}from"./index-V5C8gGmV.js";import{r as I,_ as k}from"./uni-app.es._8RPl_wK.js";import{_ as C}from"./_plugin-vue_export-helper.BCo6x5W8.js";const O=C({data:()=>({user:{id:"",name:"",email:"",avatar:"",bio:"",signature:""},tempAvatarPath:""}),async onLoad(){await this.loadUser()},methods:{async loadUser(){var r,l,o;const i=await a();if(i)this.user={id:i.$id,name:i.name,email:i.email,avatar:(null==(r=i.prefs)?void 0:r.avatar)||"",bio:(null==(l=i.prefs)?void 0:l.bio)||"",signature:(null==(o=i.prefs)?void 0:o.signature)||""},e("currentUser",this.user);else{const a=s("currentUser");a?this.user=JSON.parse(JSON.stringify(a)):t({url:"/pages/login/login"})}},changeAvatar(){r({count:1,success:a=>{this.tempAvatarPath=a.tempFilePaths[0],this.user.avatar=a.tempFilePaths[0]}})},async saveProfile(){if(this.user.name){o({title:"ä¿å­˜ä¸­..."});try{if(this.tempAvatarPath){const{data:a,error:e}=await i(this.tempAvatarPath);if(e)throw new Error("é ­åƒä¸Šå‚³å¤±æ•—: "+(e.message||JSON.stringify(e)));this.user.avatar=a.url}const{error:r}=await u(this.user.name);if(r)throw new Error("æ›´æ–°æš±ç¨±å¤±æ•—: "+r.message);const o={bio:this.user.bio||"",signature:this.user.signature||"",avatar:this.user.avatar||""},{error:b}=await n(o);if(b)throw new Error("æ›´æ–°å€‹äººè³‡æ–™å¤±æ•—: "+b.message);e("currentUser",this.user);try{const{data:a}=await c(this.user.id);if(a&&a.length>0){const e=a.slice(0,50).map((a=>a.authorName!==this.user.name||a.authorAvatar!==this.user.avatar?d(a.$id,{authorName:this.user.name,authorAvatar:this.user.avatar}):Promise.resolve()));await Promise.all(e),console.log("Updated avatar on",e.length,"posts")}}catch(a){console.error("Failed to update user posts:",a)}try{const{data:a}=await m(this.user.id);if(a&&a.length>0){const e=a.slice(0,50).map((a=>a.authorName!==this.user.name||a.authorAvatar!==this.user.avatar?h(a.$id,{authorName:this.user.name,authorAvatar:this.user.avatar}):Promise.resolve()));await Promise.all(e),console.log("Updated avatar on",e.length,"comments")}}catch(t){console.error("Failed to update user comments:",t)}let w=s("users")||[];const P=w.findIndex((a=>a.id===this.user.id));-1!==P&&(w[P]={...w[P],...this.user},e("users",w));let U=p(),x=!1;U.forEach((a=>{a.authorId===this.user.id&&(a.authorName=this.user.name,x=!0),a.comments&&a.comments.forEach((a=>{a.authorId===this.user.id&&(a.authorName=this.user.name,x=!0)}))})),x&&f(U),v(),l({title:"ä¿å­˜æˆåŠŸ"}),g("userProfileUpdated",this.user),setTimeout((()=>{_()}),1e3)}catch(r){v(),console.error(r),l({title:r.message||"ä¿å­˜å¤±æ•—",icon:"none"})}}else l({title:"æš±ç¨±ä¸èƒ½ç‚ºç©º",icon:"none"})}}},[["render",function(a,e,s,t,r,l){const o=A,i=U,u=N,n=j,c=E,d=F,m=I(b("app-tab-bar"),k);return x(),w(i,{class:"container"},{default:P((()=>[V(i,{class:"notice-bar"},{default:P((()=>[V(i,{class:"notice-content"},{default:P((()=>[V(o,{class:"notice-text"},{default:P((()=>[y("ğŸ“¢ æœ¬ç‰ˆç‰ˆè¦ï¼šåš´ç¦ç™¼ä½ˆä»»ä½•è‰²æƒ…ã€æš´åŠ›ã€è³­åšåŠè©é¨™è¨Šæ¯ã€‚è«‹ä¿æŒç¦®è²Œï¼Œå°Šé‡ä»–äººã€‚é•è€…å°‡è¢«å°ç¦ã€‚")])),_:1})])),_:1})])),_:1}),V(i,{class:"avatar-section",onClick:l.changeAvatar},{default:P((()=>[V(u,{class:"avatar",src:r.user.avatar||"/static/logo.png",mode:"aspectFill"},null,8,["src"]),V(o,{class:"change-avatar-text"},{default:P((()=>[y("æ›´æ›é ­åƒ")])),_:1})])),_:1},8,["onClick"]),V(i,{class:"form-section"},{default:P((()=>[V(i,{class:"form-item"},{default:P((()=>[V(o,{class:"label"},{default:P((()=>[y("æš±ç¨±")])),_:1}),V(n,{class:"input",type:"text",modelValue:r.user.name,"onUpdate:modelValue":e[0]||(e[0]=a=>r.user.name=a),placeholder:"è«‹è¼¸å…¥æš±ç¨±"},null,8,["modelValue"])])),_:1}),V(i,{class:"form-item"},{default:P((()=>[V(o,{class:"label"},{default:P((()=>[y("é›»å­éƒµä»¶ (ä¸å¯ä¿®æ”¹)")])),_:1}),V(n,{class:"input disabled",type:"text",modelValue:r.user.email,"onUpdate:modelValue":e[1]||(e[1]=a=>r.user.email=a),disabled:""},null,8,["modelValue"])])),_:1}),V(i,{class:"form-item"},{default:P((()=>[V(o,{class:"label"},{default:P((()=>[y("å€‹äººç°¡ä»‹")])),_:1}),V(c,{class:"textarea",modelValue:r.user.bio,"onUpdate:modelValue":e[2]||(e[2]=a=>r.user.bio=a),placeholder:"ä»‹ç´¹ä¸€ä¸‹è‡ªå·±å§...",maxlength:"100"},null,8,["modelValue"])])),_:1}),V(i,{class:"form-item"},{default:P((()=>[V(o,{class:"label"},{default:P((()=>[y("å€‹æ€§ç°½å")])),_:1}),V(n,{class:"input",type:"text",modelValue:r.user.signature,"onUpdate:modelValue":e[3]||(e[3]=a=>r.user.signature=a),placeholder:"ä¸€å¥è©±ä»£è¡¨ä½ ",maxlength:"30"},null,8,["modelValue"])])),_:1})])),_:1}),V(d,{class:"save-btn",onClick:l.saveProfile},{default:P((()=>[y("ä¿å­˜ä¿®æ”¹")])),_:1},8,["onClick"]),V(m)])),_:1})}],["__scopeId","data-v-cbcb34db"]]);export{O as default};

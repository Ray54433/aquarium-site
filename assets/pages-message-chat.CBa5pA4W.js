import{R as e,t as s,n as a,_ as t,$ as r,a0 as n,a1 as o,N as l,a2 as i,a3 as c,j as d,a4 as m,p as g,a5 as u,D as h,c as f,w as p,i as I,o as U,a as _,E as w,F as M,G as y,b as N,e as b,I as k,a6 as v,L as C,H as F,J as T,d as S}from"./index-BurITbpl.js";import{r as x,_ as j}from"./uni-app.es.DTb5EvbE.js";import{_ as D}from"./_plugin-vue_export-helper.BCo6x5W8.js";const $=D({data:()=>({targetUserId:"",targetUserName:"",currentUserId:"",currentUserName:"",messages:[],newMessage:"",refreshInterval:null}),onLoad(r){this.targetUserId=r.targetUserId,this.targetUserName=r.targetUserName,e({title:this.targetUserName||"èŠå¤©"});const n=s();n?(this.currentUserId=n.id,this.currentUserName=n.name,this.loadMessages(),this.refreshInterval=setInterval((()=>{this.loadMessages(!0)}),3e3)):(a({title:"è«‹å…ˆç™»å…¥",icon:"none"}),setTimeout((()=>t()),1500))},onUnload(){this.refreshInterval&&clearInterval(this.refreshInterval)},methods:{async loadMessages(e=!1){const{data:s,error:a}=await r(this.currentUserId,this.targetUserId);s&&JSON.stringify(s)!==JSON.stringify(this.messages)&&(this.messages=s,e||this.scrollToBottom())},scrollToBottom(){setTimeout((()=>{n({scrollTop:99999,duration:100})}),100)},async sendMessage(){if(!this.newMessage.trim())return;const e=this.newMessage;this.newMessage="";const s={senderId:this.currentUserId,senderName:this.currentUserName,receiverId:this.targetUserId,receiverName:this.targetUserName,content:e,timestamp:Math.floor(Date.now()/1e3),read:!1};this.messages.push(s),this.scrollToBottom();const{error:t}=await o(s);t?(console.error("Send message failed",t),a({title:"ç™¼é€å¤±æ•—",icon:"none"})):this.loadMessages(!0)},async deleteMessage(e,s){l({title:"ç¢ºèªåˆªé™¤",content:"ç¢ºå®šè¦åˆªé™¤é€™æ¢è¨Šæ¯å—ï¼Ÿ",success:async a=>{if(a.confirm&&(this.messages.splice(s,1),e.$id)){const{error:s}=await i(e.$id);s&&console.error("Delete message error",s)}}})},chooseImage(){c({count:1,sizeType:["original","compressed"],sourceType:["album","camera"],success:async e=>{let s;console.log("Image Chosen:",e),d({title:"ç™¼é€åœ–ç‰‡ä¸­..."}),e.tempFiles&&e.tempFiles.length>0?(s=e.tempFiles[0],s instanceof File||s instanceof Blob||(console.warn("H5 tempFile is not a File object, using path"),s=e.tempFilePaths[0])):s=e.tempFilePaths[0],console.log("Uploading file:",s);try{const{data:e,error:t}=await m(s);if(e&&e.url){console.log("Upload Success:",e.url);const s={senderId:this.currentUserId,senderName:this.currentUserName,receiverId:this.targetUserId,receiverName:this.targetUserName,content:"[åœ–ç‰‡]",image:e.url,timestamp:Math.floor(Date.now()/1e3),read:!1},{error:t}=await o(s);t?(console.error("Send image message failed",t),a({title:"ç™¼é€å¤±æ•—",icon:"none"})):this.loadMessages()}else console.error("Upload failed, data null or error:",t),a({title:"åœ–ç‰‡ä¸Šå‚³å¤±æ•—: "+(t?t.message||t:"Unknown"),icon:"none"})}catch(t){console.error("Upload Exception:",t),a({title:"ä¸Šå‚³ç•°å¸¸",icon:"none"})}finally{g()}},fail:e=>{console.error("Choose image failed",e),a({title:"é¸æ“‡åœ–ç‰‡å¤±æ•—",icon:"none"})}})},viewImage(e){u({urls:[e]})},formatTime(e){if(!e)return"";const s=new Date(1e3*e);return`${s.getHours()}:${s.getMinutes().toString().padStart(2,"0")}`}}},[["render",function(e,s,a,t,r,n){const o=b,l=I,i=S,c=k,d=v,m=x(h("app-tab-bar"),j);return U(),f(l,{class:"container"},{default:p((()=>[_(l,{class:"chat-list",id:"chat-list"},{default:p((()=>[(U(!0),w(y,null,M(r.messages,((e,s)=>(U(),f(l,{key:s,class:C(["message-row",{"my-message":e.senderId===r.currentUserId}])},{default:p((()=>[_(l,{class:"message-container"},{default:p((()=>[e.senderId===r.currentUserId?(U(),f(l,{key:0,class:"delete-btn",onClick:a=>n.deleteMessage(e,s)},{default:p((()=>[_(o,null,{default:p((()=>[N("ğŸ—‘ï¸")])),_:1})])),_:2},1032,["onClick"])):F("",!0),_(l,{class:"message-bubble"},{default:p((()=>[_(o,{class:"message-text"},{default:p((()=>[N(T(e.content),1)])),_:2},1024),e.image?(U(),f(i,{key:0,src:e.image,mode:"widthFix",class:"message-image",onClick:s=>n.viewImage(e.image)},null,8,["src","onClick"])):F("",!0)])),_:2},1024),e.senderId!==r.currentUserId?(U(),f(l,{key:1,class:"delete-btn",onClick:a=>n.deleteMessage(e,s)},{default:p((()=>[_(o,null,{default:p((()=>[N("ğŸ—‘ï¸")])),_:1})])),_:2},1032,["onClick"])):F("",!0)])),_:2},1024),_(o,{class:"message-time"},{default:p((()=>[N(T(n.formatTime(e.timestamp)),1)])),_:2},1024)])),_:2},1032,["class"])))),128)),_(l,{id:"scroll-bottom"})])),_:1}),_(l,{class:"input-area"},{default:p((()=>[_(l,{class:"icon-btn",onClick:n.chooseImage},{default:p((()=>[_(o,null,{default:p((()=>[N("ğŸ“·")])),_:1})])),_:1},8,["onClick"]),_(c,{class:"chat-input",modelValue:r.newMessage,"onUpdate:modelValue":s[0]||(s[0]=e=>r.newMessage=e),placeholder:"è¼¸å…¥è¨Šæ¯...","confirm-type":"send",onConfirm:n.sendMessage},null,8,["modelValue","onConfirm"]),_(d,{class:"send-btn",onClick:n.sendMessage},{default:p((()=>[N("ç™¼é€")])),_:1},8,["onClick"])])),_:1}),_(m)])),_:1})}],["__scopeId","data-v-0b64c7da"]]);export{$ as default};

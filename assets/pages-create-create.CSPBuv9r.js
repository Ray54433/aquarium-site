import{C as e,R as t,t as i,M as s,B as a,aa as o,l,a3 as d,a5 as r,n,N as c,s as u,q as g,j as h,a4 as y,O as p,at as C,ah as m,p as f,D as I,c as b,w as x,i as T,o as _,a as L,b as k,J as M,H as v,L as w,E as S,F as N,G as P,e as E,au as D,I as V,aj as A,a6 as $,K as j,d as J}from"./index-DeSSVyR4.js";import{r as O,_ as U}from"./uni-app.es._Cs-_V8k.js";import{_ as F}from"./_plugin-vue_export-helper.BCo6x5W8.js";const H=F({data:()=>({isEditMode:!1,editPostId:null,isMod:!1,isTradeMode:!1,tradeType:"wtb",isCircleMode:!1,circleTopic:"",title:"",content:"",images:[],categories:e,categoryIndex:-1,subCategoryIndex:-1,detailCategoryIndex:-1,categoryList:[],subCategoryList:[],detailCategoryList:[],postType:"discussion",price:""}),computed:{categoryNames(){return this.categoryList.map((e=>e.name))},subCategoryNames(){return this.subCategoryList.map((e=>e.name))},detailCategoryNames(){return this.detailCategoryList.map((e=>e.name))},canHaveAuction(){if(this.categoryIndex<0)return!1;const e=this.categoryList[this.categoryIndex].id;return["saltwater","freshwater","plants","crystal_shrimp"].includes(e)},pricePlaceholder(){return"auction"===this.postType?"Ëµ∑ÊãçÂÉπ ($)":"wtb"===this.tradeType?"ÂæµÊ±ÇÈ†êÁÆó ($)":"Âá∫ÂîÆÂÉπÊ†º ($)"}},onLoad(e){if(this.initCategories(),e.categoryId){const t={categoryId:e.categoryId,subCategoryId:e.subCategoryId,detailCategoryId:e.detailCategoryId};setTimeout((()=>{this.handlePreSelect(t)}),100)}"trade"===e.mode?(this.isTradeMode=!0,this.tradeType=e.type||"wtb",t({title:"wtb"===this.tradeType?"Áôº‰ΩàÂæµÊ±Ç":"Áôº‰ΩàÂá∫ÂîÆ"})):"circle"===e.mode?(this.isCircleMode=!0,this.circleTopic=e.topic||"",t({title:`Áôº‰Ωà: ${this.circleTopic}`})):"auction"===e.type?(this.postType="auction",t({title:"Áôº‰ΩàÊãçË≥£"})):e.edit&&e.id&&(this.isEditMode=!0,this.editPostId=e.id,this.loadPostData(e.id),t({title:"‰øÆÊîπÂ∏ñÂ≠ê"}))},onShow(){const e=i();if(this.isMod=s(e),this.initCategories(),!this.isEditMode){const e=a("preSelectCategory");e&&(o("preSelectCategory"),this.handlePreSelect(e))}},methods:{initCategories(){this.categories&&Array.isArray(this.categories)?this.categoryList=this.categories.filter((e=>"business"!==e.id&&("brands"!==e.id||this.isMod))):(this.categoryList=[],console.warn("Categories data is missing or invalid"))},loadPostData(e){const t=l().find((t=>t.id===e));if(t){this.title=t.title,this.content=t.content,this.images=t.images||(t.image?[t.image]:[]),this.postType=t.type||"discussion",this.price=t.price||"",this.video=t.video||null;const e=this.categoryList.findIndex((e=>e.id===t.categoryId));if(e>=0&&(this.categoryIndex=e,this.updateSubCategoryList(e),t.subCategoryId&&this.subCategoryList.length>0)){const e=this.subCategoryList.findIndex((e=>e.id===t.subCategoryId));if(e>=0&&(this.subCategoryIndex=e,this.updateDetailCategoryList(e),t.detailCategoryId&&this.detailCategoryList.length>0)){const e=this.detailCategoryList.findIndex((e=>e.id===t.detailCategoryId));e>=0&&(this.detailCategoryIndex=e)}}}},handlePreSelect(e){if(!e||!e.categoryId)return;const t=this.categoryList.findIndex((t=>t.id==e.categoryId));if(t>=0){if(this.categoryIndex=t,this.updateSubCategoryList(t),e.subCategoryId){const t=this.subCategoryList.findIndex((t=>t.id==e.subCategoryId));if(t>=0){if(this.subCategoryIndex=t,this.updateDetailCategoryList(t),e.detailCategoryId){const t=this.detailCategoryList.findIndex((t=>t.id==e.detailCategoryId));t>=0&&(this.detailCategoryIndex=t)}}else console.log("SubCategory not found:",e.subCategoryId,"in",this.subCategoryList)}}else console.warn("Category not found or filtered:",e.categoryId)},updateSubCategoryList(e){const t=this.categoryList[e];t&&t.children&&t.children.length>0?this.subCategoryList=t.children:this.subCategoryList=[],this.subCategoryIndex=-1,this.detailCategoryList=[],this.detailCategoryIndex=-1},updateDetailCategoryList(e){const t=this.subCategoryList[e];t&&t.children&&t.children.length>0?this.detailCategoryList=t.children:this.detailCategoryList=[],this.detailCategoryIndex=-1},bindCategoryChange(e){this.categoryIndex=e.detail.value,this.updateSubCategoryList(this.categoryIndex)},bindSubCategoryChange(e){this.subCategoryIndex=e.detail.value,this.updateDetailCategoryList(this.subCategoryIndex)},bindDetailCategoryChange(e){this.detailCategoryIndex=e.detail.value},chooseImage(){d({count:9-this.images.length,sizeType:["original","compressed"],sourceType:["album","camera"],success:e=>{console.log("Create Post Choose Image:",e),this.images=[...this.images,...e.tempFilePaths]}})},viewImage(e){r({urls:this.images,current:e})},deleteImage(e){this.images.splice(e,1)},async submitPost(){if(!this.isCircleMode){if(this.categoryIndex<0)return void n({title:"Ë´ãÈÅ∏ÊìáÂàÜÈ°û",icon:"none"});if(this.subCategoryList.length>0&&this.subCategoryIndex<0)return void n({title:"Ë´ãÈÅ∏ÊìáÂ≠êÂàÜÈ°û",icon:"none"})}if(this.title&&this.content){if(!this.isTradeMode&&"auction"!==this.postType&&!this.isMod){const e=["Âá∫ÂîÆ","ÊîæÂîÆ","Ë≥£","ÂÉπÈå¢","ÊúâÊÑèpm","ÁßÅ‰øù","‰∫§Êî∂","wts","wtb","Êî∂Ë≥º","Âπ≥Êîæ","Ê∏ÖÁº∏"],t=/[\$ÔºÑ]\d+/,i=(this.title+" "+this.content).toLowerCase();let s=!1;for(const a of e)if(i.includes(a.toLowerCase())){s=!0;break}if(t.test(i)&&(s=!0),s)return void c({title:"‚ö†Ô∏è Ê™¢Ê∏¨Âà∞‰∫§ÊòìÂÖßÂÆπ",content:"Á≥ªÁµ±Ê™¢Ê∏¨Âà∞ÊÇ®ÁöÑÂ∏ñÂ≠êÂèØËÉΩÂåÖÂê´Ë≤∑Ë≥£/‰∫§ÊòìË®äÊÅØ„ÄÇ\n\nË´ãÂ∞áÊ≠§È°ûÂÖßÂÆπÁôº‰ΩàËá≥„Äå‰∫§ÊòìÂçÄ„ÄçÊàñÈÅ∏Êìá„ÄåÊãçË≥£„ÄçÈ°ûÂûãÔºå‰ª•ÂÖçÈÅïË¶èË¢´Âà™Â∏ñ„ÄÇ",confirmText:"Âéª‰∫§ÊòìÂçÄ",cancelText:"ËøîÂõû‰øÆÊîπ",success:e=>{e.confirm?u({url:"/pages/market/market"}):e.cancel}})}this.doSubmit()}else n({title:"Ë´ãÂ°´ÂØ´Ê®ôÈ°åÂíåÂÖßÂÆπ",icon:"none"})},async doSubmit(){const e=a("currentUser");if(!e)return n({title:"Ë´ãÂÖàÁôªÂÖ•",icon:"none"}),void setTimeout((()=>{g({url:"/pages/login/login"})}),1500);h({title:"Áôº‰Ωà‰∏≠...",mask:!0});try{let t=null,i=null,s=null;if(this.isCircleMode)t="circle",i=this.circleTopic;else{let e=this.subCategoryList[this.subCategoryIndex],a=this.detailCategoryList[this.detailCategoryIndex];t=this.categoryList[this.categoryIndex].id,i=e?e.id:null,s=a?a.id:null}let a=[];if(this.images.length>0)for(const e of this.images)if(e.startsWith("http"))a.push(e);else{const{data:t,error:i}=await y(e);if(i)throw new Error("ÂúñÁâá‰∏äÂÇ≥Â§±Êïó");a.push(t.url)}const o={authorId:e.id,authorName:e.name,title:this.title,content:this.content,images:JSON.stringify(a),video:null,timestamp:Math.floor(Date.now()/1e3),categoryId:t,subCategoryId:i,detailCategoryId:s,type:this.isTradeMode?this.tradeType:this.postType,price:"auction"===this.postType||this.isTradeMode?this.price:null,comments:JSON.stringify([]),likes:JSON.stringify([])};"auction"===this.postType&&this.auctionEndTime&&(o.auctionEndTime=this.auctionEndTime.toString());let d=null;if(this.isEditMode&&this.editPostId){const{data:e,error:t}=await p(this.editPostId,o);if(t)throw t;d={...o,id:this.editPostId}}else{const{data:e,error:t}=await C(o);if(t)throw t;d={...o,id:e.$id}}d.images=a,d.video=null,d.comments=[],d.likes=[];let r=l();if(this.isEditMode){const e=r.findIndex((e=>e.id===this.editPostId));-1!==e&&(r[e]=d)}else r.unshift(d);m(r),f(),n({title:this.isEditMode?"Êõ¥Êñ∞ÊàêÂäü":"Áôº‰ΩàÊàêÂäü"}),this.title="",this.content="",this.images=[],this.video=null,this.categoryIndex=-1,this.subCategoryIndex=-1,setTimeout((()=>{this.isTradeMode?u({url:"/pages/market/market"}):this.isCircleMode?u({url:"/pages/circle/circle"}):u({url:"/pages/home/home"})}),1e3)}catch(t){f(),console.error("Submit post error:",t);let e="Áôº‰ΩàÂ§±Êïó: ";const i=t.message||("string"==typeof t?t:JSON.stringify(t));e+=i,i.includes("attribute_not_found")?e="Êï∏ÊìöÂ∫´Â≠óÊÆµÁº∫Â§± (Ë´ãÊ™¢Êü• Appwrite Attributes)":i.includes("user_unauthorized")||i.includes("missing_scope")||i.includes("401")?e="Ê¨äÈôê‰∏çË∂≥ (Ë´ãÈáçÊñ∞ÁôªÂÖ•)":i.includes("Network request failed")&&(e="Á∂≤Áµ°ÈÄ£Êé•Â§±Êïó (Ë´ãÊ™¢Êü•Á∂≤Áµ°)"),n({title:e,icon:"none",duration:4e3})}}}},[["render",function(e,t,i,s,a,o){const l=E,d=T,r=D,n=V,c=A,u=J,g=$,h=O(I("app-tab-bar"),U);return _(),b(d,{class:"container"},{default:x((()=>[L(d,{class:"notice-bar"},{default:x((()=>[L(d,{class:"notice-content"},{default:x((()=>[L(l,{class:"notice-text"},{default:x((()=>[k("üì¢ Êú¨ÁâàÁâàË¶èÔºöÂö¥Á¶ÅÁôº‰Ωà‰ªª‰ΩïËâ≤ÊÉÖ„ÄÅÊö¥Âäõ„ÄÅË≥≠ÂçöÂèäË©êÈ®ôË®äÊÅØ„ÄÇË´ã‰øùÊåÅÁ¶ÆË≤åÔºåÂ∞äÈáç‰ªñ‰∫∫„ÄÇÈÅïËÄÖÂ∞áË¢´Â∞ÅÁ¶Å„ÄÇ")])),_:1})])),_:1})])),_:1}),a.isCircleMode?v("",!0):(_(),b(d,{key:0,class:"form-item"},{default:x((()=>[L(r,{onChange:o.bindCategoryChange,value:a.categoryIndex,range:o.categoryNames},{default:x((()=>[L(d,{class:"picker"},{default:x((()=>[k(M(a.categoryIndex>=0?o.categoryNames[a.categoryIndex]:"Ë´ãÈÅ∏ÊìáÂàÜÈ°û"),1)])),_:1})])),_:1},8,["onChange","value","range"])])),_:1})),!a.isCircleMode&&o.subCategoryNames.length>0?(_(),b(d,{key:1,class:"form-item"},{default:x((()=>[L(r,{onChange:o.bindSubCategoryChange,value:a.subCategoryIndex,range:o.subCategoryNames},{default:x((()=>[L(d,{class:"picker"},{default:x((()=>[k(" Â≠êÂàÜÈ°ûÔºö"+M(o.subCategoryNames[a.subCategoryIndex]||"Ë´ãÈÅ∏ÊìáÂ≠êÂàÜÈ°û"),1)])),_:1})])),_:1},8,["onChange","value","range"])])),_:1})):v("",!0),!a.isCircleMode&&o.detailCategoryNames.length>0?(_(),b(d,{key:2,class:"form-item"},{default:x((()=>[L(r,{onChange:o.bindDetailCategoryChange,value:a.detailCategoryIndex,range:o.detailCategoryNames},{default:x((()=>[L(d,{class:"picker"},{default:x((()=>[k(" Ë©≥Á¥∞ÂàÜÈ°ûÔºö"+M(o.detailCategoryNames[a.detailCategoryIndex]||"Ë´ãÈÅ∏ÊìáË©≥Á¥∞ÂàÜÈ°û"),1)])),_:1})])),_:1},8,["onChange","value","range"])])),_:1})):v("",!0),a.isTradeMode?(_(),b(d,{key:3,class:"trade-type-info"},{default:x((()=>[L(l,{class:"trade-label"},{default:x((()=>[k("‰∫§ÊòìÈ°ûÂûãÔºö")])),_:1}),L(l,{class:w(["trade-value",a.tradeType])},{default:x((()=>[k(M("wtb"===a.tradeType?"üîç ÂæµÊ±Ç (Ë≤∑)":"üí∞ Âá∫ÂîÆ (Ë≥£)"),1)])),_:1},8,["class"])])),_:1})):v("",!0),!a.isTradeMode&&o.canHaveAuction?(_(),b(d,{key:4,class:"post-type-section"},{default:x((()=>[L(l,{class:"section-label"},{default:x((()=>[k("Â∏ñÂ≠êÈ°ûÂûãÔºö")])),_:1}),L(d,{class:"type-options"},{default:x((()=>[L(d,{class:w(["type-option",{active:"discussion"===a.postType}]),onClick:t[0]||(t[0]=e=>a.postType="discussion")},{default:x((()=>[L(l,null,{default:x((()=>[k("üí¨ Ë®éË´ñ")])),_:1})])),_:1},8,["class"]),L(d,{class:w(["type-option",{active:"auction"===a.postType}]),onClick:t[1]||(t[1]=e=>a.postType="auction")},{default:x((()=>[L(l,null,{default:x((()=>[k("üî® ÊãçË≥£")])),_:1})])),_:1},8,["class"])])),_:1})])),_:1})):v("",!0),"auction"===a.postType||a.isTradeMode?(_(),b(d,{key:5,class:"auction-fields"},{default:x((()=>[L(n,{class:"price-input",type:"number",placeholder:o.pricePlaceholder,modelValue:a.price,"onUpdate:modelValue":t[2]||(t[2]=e=>a.price=e)},null,8,["placeholder","modelValue"])])),_:1})):v("",!0),L(n,{class:"title-input",placeholder:"Â∏ñÂ≠êÊ®ôÈ°å",modelValue:a.title,"onUpdate:modelValue":t[3]||(t[3]=e=>a.title=e),"placeholder-style":"color:#999"},null,8,["modelValue"]),L(c,{class:"content-input",placeholder:"ÂàÜ‰∫´‰Ω†ÁöÑÊ∞¥ÊóèÊïÖ‰∫ã...",modelValue:a.content,"onUpdate:modelValue":t[4]||(t[4]=e=>a.content=e),maxlength:"1000"},null,8,["modelValue"]),L(d,{class:"image-area"},{default:x((()=>[L(d,{class:"image-grid"},{default:x((()=>[(_(!0),S(P,null,N(a.images,((e,t)=>(_(),b(d,{key:t,class:"image-item"},{default:x((()=>[L(u,{src:e,mode:"aspectFill",class:"preview-image",onClick:e=>o.viewImage(t)},null,8,["src","onClick"]),L(d,{class:"delete-btn",onClick:j((e=>o.deleteImage(t)),["stop"])},{default:x((()=>[k("√ó")])),_:2},1032,["onClick"])])),_:2},1024)))),128)),a.images.length<9?(_(),b(d,{key:0,class:"upload-btn",onClick:o.chooseImage},{default:x((()=>[L(l,{class:"upload-text"},{default:x((()=>[k("+ ÂúñÁâá")])),_:1})])),_:1},8,["onClick"])):v("",!0)])),_:1})])),_:1}),L(g,{class:"submit-btn",onClick:o.submitPost},{default:x((()=>[k(M(a.isEditMode?"Êõ¥Êñ∞Â∏ñÂ≠ê":"Áôº‰Ωà"),1)])),_:1},8,["onClick"]),L(h)])),_:1})}],["__scopeId","data-v-ae558f41"]]);export{H as default};

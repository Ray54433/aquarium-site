import{Q as e,r as s,m as a,Z as t,_ as r,$ as n,a0 as i,M as o,a1 as l,a2 as c,h as d,a3 as m,n as u,a4 as g,B as h,c as f,w as I,i as U,o as p,a as _,D as M,E as w,F as N,b as k,e as v,I as y,a5 as C,K as b,G as T,H as x,d as D}from"./index-cizoypdI.js";import{r as S,_ as $}from"./uni-app.es.EehqqviQ.js";import{_ as B}from"./_plugin-vue_export-helper.BCo6x5W8.js";const j=B({data:()=>({targetUserId:"",targetUserName:"",currentUserId:"",currentUserName:"",messages:[],newMessage:"",refreshInterval:null}),onLoad(r){this.targetUserId=r.targetUserId,this.targetUserName=r.targetUserName,e({title:this.targetUserName||"èŠå¤©"});const n=s();n?(this.currentUserId=n.id,this.currentUserName=n.name,this.loadMessages(),this.refreshInterval=setInterval((()=>{this.loadMessages(!0)}),3e3)):(a({title:"è«‹å…ˆç™»å…¥",icon:"none"}),setTimeout((()=>t()),1500))},onUnload(){this.refreshInterval&&clearInterval(this.refreshInterval)},methods:{async loadMessages(e=!1){const{data:s,error:a}=await r(this.currentUserId,this.targetUserId);s&&JSON.stringify(s)!==JSON.stringify(this.messages)&&(this.messages=s,e||this.scrollToBottom())},scrollToBottom(){setTimeout((()=>{n({scrollTop:99999,duration:100})}),100)},async sendMessage(){if(!this.newMessage.trim())return;const e=this.newMessage;this.newMessage="";const s={senderId:this.currentUserId,senderName:this.currentUserName,receiverId:this.targetUserId,receiverName:this.targetUserName,content:e,timestamp:Math.floor(Date.now()/1e3),read:!1};this.messages.push(s),this.scrollToBottom();const{error:t}=await i(s);t?(console.error("Send message failed",t),a({title:"ç™¼é€å¤±æ•—",icon:"none"})):this.loadMessages(!0)},async deleteMessage(e,s){o({title:"ç¢ºèªåˆªé™¤",content:"ç¢ºå®šè¦åˆªé™¤é€™æ¢è¨Šæ¯å—ï¼Ÿ",success:async a=>{if(a.confirm&&(this.messages.splice(s,1),e.$id)){const{error:s}=await l(e.$id);s&&console.error("Delete message error",s)}}})},chooseImage(){c({count:1,success:async e=>{d({title:"ç™¼é€åœ–ç‰‡ä¸­..."});const s=e.tempFilePaths[0],{data:t,error:r}=await m(s);if(t&&t.url){const e={senderId:this.currentUserId,senderName:this.currentUserName,receiverId:this.targetUserId,receiverName:this.targetUserName,content:"[åœ–ç‰‡]",image:t.url,timestamp:Math.floor(Date.now()/1e3),read:!1};await i(e),this.loadMessages(),u()}else u(),a({title:"åœ–ç‰‡ä¸Šå‚³å¤±æ•—",icon:"none"})}})},viewImage(e){g({urls:[e]})},formatTime(e){if(!e)return"";const s=new Date(1e3*e);return`${s.getHours()}:${s.getMinutes().toString().padStart(2,"0")}`}}},[["render",function(e,s,a,t,r,n){const i=v,o=U,l=D,c=y,d=C,m=S(h("app-tab-bar"),$);return p(),f(o,{class:"container"},{default:I((()=>[_(o,{class:"chat-list",id:"chat-list"},{default:I((()=>[(p(!0),M(N,null,w(r.messages,((e,s)=>(p(),f(o,{key:s,class:b(["message-row",{"my-message":e.senderId===r.currentUserId}])},{default:I((()=>[_(o,{class:"message-container"},{default:I((()=>[e.senderId===r.currentUserId?(p(),f(o,{key:0,class:"delete-btn",onClick:a=>n.deleteMessage(e,s)},{default:I((()=>[_(i,null,{default:I((()=>[k("ğŸ—‘ï¸")])),_:1})])),_:2},1032,["onClick"])):T("",!0),_(o,{class:"message-bubble"},{default:I((()=>[_(i,{class:"message-text"},{default:I((()=>[k(x(e.content),1)])),_:2},1024),e.image?(p(),f(l,{key:0,src:e.image,mode:"widthFix",class:"message-image",onClick:s=>n.viewImage(e.image)},null,8,["src","onClick"])):T("",!0)])),_:2},1024),e.senderId!==r.currentUserId?(p(),f(o,{key:1,class:"delete-btn",onClick:a=>n.deleteMessage(e,s)},{default:I((()=>[_(i,null,{default:I((()=>[k("ğŸ—‘ï¸")])),_:1})])),_:2},1032,["onClick"])):T("",!0)])),_:2},1024),_(i,{class:"message-time"},{default:I((()=>[k(x(n.formatTime(e.timestamp)),1)])),_:2},1024)])),_:2},1032,["class"])))),128)),_(o,{id:"scroll-bottom"})])),_:1}),_(o,{class:"input-area"},{default:I((()=>[_(o,{class:"icon-btn",onClick:n.chooseImage},{default:I((()=>[_(i,null,{default:I((()=>[k("ğŸ“·")])),_:1})])),_:1},8,["onClick"]),_(c,{class:"chat-input",modelValue:r.newMessage,"onUpdate:modelValue":s[0]||(s[0]=e=>r.newMessage=e),placeholder:"è¼¸å…¥è¨Šæ¯...","confirm-type":"send",onConfirm:n.sendMessage},null,8,["modelValue","onConfirm"]),_(d,{class:"send-btn",onClick:n.sendMessage},{default:I((()=>[k("ç™¼é€")])),_:1},8,["onClick"])])),_:1}),_(m)])),_:1})}],["__scopeId","data-v-ad604612"]]);export{j as default};
